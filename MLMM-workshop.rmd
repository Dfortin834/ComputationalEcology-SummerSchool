
---
title: Analysis of predator forging behaviour using multivariate linear mixed effects models
author:
  - name: Maxime Fraser Franco
    affiliation: Département des Sciences Biologiques & Centre de la Science de la Biodiversité du Québec, Université du Québec à Montréal
    email: fraser_franco.maxime@courrier.uqam.ca
  - name: Pierre-Olivier Montiglio
    affiliation: Département des Sciences Biologiques & Centre de la Science de la Biodiversité du Québec, Université du Québec à Montréal
    email: montiglio.pierre-olivier@uqam.ca
  - name: Pierre-Legagneux
    affiliation: Département de Biologie & Centre d'Études Nordiques, Université Laval
    email: Pierre.Legagneux@bio.ulaval.ca
  - name: Daniel Fortin
    affiliation: Département de Biologie & Centre d'étude de la forêt, Université Laval
    email: Daniel.Fortin@bio.ulaval.ca
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_float: yes
    highlight: zenburn
    theme: flatly
    df_print: paged
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  fig.align = "center",
  warning = FALSE, 
  message = FALSE
)
```

<br>



# Overview

<br>



# Case study

Explain my study briefly.

The code to reproduce all the analyse presented in the article is available on [GitHub](https://github.com/quantitative-ecologist/predator-foraging-mode-videogames)

<br>



# The data

Explain the dataset


## Load the libraries

In this tutorial, we will use the [`data.table`](https://rdatatable.gitlab.io/data.table/index.html) R package for data wrangling. `data.table` is a fast and very useful package for data science in general, and is great for manipulating large datasets. It operates similarly to base R's `data.frame`.

We will fit all our models using the package [`brms`](https://paul-buerkner.github.io/brms/), which is an R front-end for the probabilistic language [STAN](https://mc-stan.org/) software. `brms` uses Hamiltonian Monte Carlo (HMC) and the no-U-turn sampler (NUTS) to estimate the model parameters.

Lastly, we use the [`ggplot2`](https://ggplot2.tidyverse.org/) R package for our plots.

```{r}

# libraries
library(data.table)
library(brms)
library(ggplot2)

```


## Import the data

The data is hosted on a public repository on GitHub. We will export it from there.

```{r}

# Type the repository's URL
github <- "https://raw.githubusercontent.com/quantitative-ecologist"
repository <- "predator-foraging-mode-videogames"
folder <- "main/data"

# Import the data in our session
data <- fread(
  file.path(
    github, repository,
    folder, "FraserFrancoetal2022-data.csv"
  ),
  select = c(
    "player_id", "avatar_id",
    "hunting_success", "game_duration",
    "speed", "space_covered_rate", "hook_start_time",
    "prey_avg_speed", "prey_avg_space_covered_rate"
  )
)

# Rename variables
setnames(data, "hook_start_time", "latency_1st_capture")
setnames(data, "speed", "pred_speed")
setnames(data, "player_id", "predator_id")

```


## Data exploration

### Data structure
```{r}
# Print the data
data

# Inspect the number of avatars
length(unique(data$avatar_id))

# Inspect the number of individual predators
length(unique(data$predator_id))

```

### Distribution of variables
```{r, out.width="100%", out.height="70%"}

# Reshape the data to plot multiple histograms -----------------------------------

# Select the needed variables
dat_hist <- data[
  , .(
    pred_speed, space_covered_rate,
    prey_avg_speed, prey_avg_space_covered_rate,
    latency_1st_capture, game_duration
  )
]

# Reshape the table
dat_hist <- melt(
  data = dat_hist,
  variable.name = "variable",
  value.name = "value"
)



# Plot the histograms ------------------------------------------------------------

# Panel labels
labels <- labeller(
  variable =
  c("pred_speed" = "Predator speed",
    "space_covered_rate" = "Rate of space coverage",
    "prey_avg_speed" = "Prey speed",
    "prey_avg_space_covered_rate" = "Prey's rate of space coverage",
    "latency_1st_capture" = "Latency for 1st capture",
    "game_duration" = "Game duration")
)

p <- ggplot(data = dat_hist, aes(x = value)) +
  geom_histogram(col = "black", fill = "gray") +
  xlab("\nValue") +
  ylab("Frequency\n") +
  facet_wrap(~ variable, scales = "free", labeller = labels) +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank(), strip.text = element_text(size = 8))

# Show figure
p

```

<br>



# Fitting a multivariate linear mixed effects model: Bayesian inference with the package `brms`


## Transforming and standardizing our variables

```{r}

# Transform our variables
data[, ":=" (
  latency_1st_capture = log(latency_1st_capture + 1),
  game_duration = sqrt(game_duration)
  )
]


# Standardize the variables
standardize <- function (x) {
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}

data[
  , c("Zgame_duration",
      "Zpred_speed",
      "Zspace_covered_rate",
      "Zlatency_1st_capture",
      "Zprey_avg_speed", 
      "Zprey_avg_space_covered_rate") :=
  lapply(.SD, standardize),
  .SDcols = c(4:9)
]

```


## Building the model

### Model 1 - Hunting tactics without controlling for prey behaviour

```{r}

# Model for the predator's speed
speed_form1 <- bf(
  Zpred_speed ~
  1 +
  (1 | a | character_name) +
  (1 | b | player_id)
) + gaussian()

# Model for the rate of space covered by the predator
space_form1 <- bf(
  Zspace_covered_rate ~
  1 +
  (1 | a | character_name) +
  (1 | b | player_id)
) + gaussian()

# Model for the latency before the 1st capture
hook_form1 <- bf(
  Zlatency_1st_capture ~
  1 +
  Zgame_duration +
  (1 | a | character_name) +
  (1 | b | player_id)
) + gaussian()

```

### Model 2 - Hunting tactics controlling for prey behaviour

```{r}

# Model for the predator's speed
speed_form2 <- bf(
  Zpred_speed ~
  1 +
  Zprey_avg_speed +
  Zprey_avg_space_covered_rate +
  (1 | a | character_name) +
  (1 | b | player_id)
) + gaussian()

# Model for the rate of space covered by the predator
space_form2 <- bf(
  Zspace_covered_rate ~
  1 +
  Zprey_avg_speed +
  Zprey_avg_space_covered_rate +
  (1 | a | character_name) +
  (1 | b | player_id)
) + gaussian()

# Model for the latency before the 1st capture
hook_form2 <- bf(
  Zlatency_1st_capture ~
  1 +
  Zprey_avg_speed +
  Zprey_avg_space_covered_rate +
  Zgame_duration +
  (1 | a | character_name) +
  (1 | b | player_id)
) + gaussian()

```

### Setting up priors

```{r}

# Priors for model 1
priors1 <- c(
  # priors on fixed effects
  set_prior(
    "normal(0, 2)",
    class = "b",
    coef = "Zgame_duration",
    resp = "Zlatency1stcapture"
  ),
  # priors on var. parameters (brms automatically detects half-normal)
  set_prior(
    "normal(0, 1)",
    class = "sd", # applies to all variance parameters
    resp = c("Zpredspeed", "Zspacecoveredrate", "Zlatency1stcapture")
  ),
  # priors on the variance-covariance matrices
  set_prior(
    "lkj(2)",
    class = "cor",
    group = "avatar_id"
  ),
  set_prior(
    "lkj(2)",
    class = "cor",
    group = "player_id"
  )
)

# Priors for model 2
priors2 <- c(
  priors1,
  set_prior(
    "normal(0, 2)",
    class = "b",
    coef = c("Zprey_avg_speed", "Zprey_avg_space_covered_rate"),
    resp = c("Zpredspeed", "Zspacecoveredrate", "Zlatency1stcapture",
             "Zpredspeed", "Zspacecoveredrate", "Zlatency1stcapture")
  )
)

```


## Run the models

Here is the basic function to run the models using `brms`. Because both models take a lot of time to estimate all the parameters, we will directly import their resulting R objects into our session. Thus, whenever you run a model that takes a very long time to compute, you should save the output into an R object and save it in a directory to reuse it later (e.g. for plots, tables, etc.).

**Import the model into our session**

```{r eval = FALSE}

path <- file.path(getwd())

fit1 <- readRDS(file.path(path, "mv_model1.rds"))
fit2 <- readRDS(file.path(path, "mv_model2.rds"))

```


**Code for Model 1 where we do not account for prey behaviour :**

```{r eval = FALSE}

# Model 1
fit1 <- brm(
  # The three model formulas are summed
  speed_form1 +
  space_form1 +
  hook_form1 +
  # To estimate residual correlations
  # i.e. inference about behavioural plasticity
  set_rescor(TRUE),
  # MCMC settings to obtain 1000 posterior samples
  # (iter - warmups) / thin * chains
  warmup = 500,
  iter = 2500,
  thin = 8,
  chains = 4,
  # Initialize parameter values at 0
  inits = "0",
  # Within-chain parallelization :
  # Use only if you have access to multiple computer cores
  threads = threading(10),
  # Software backend for MCMC estimation
  backend = "cmdstanr",
  seed = 123,
  prior = priors1,
  # Helps MCMC convergence
  control = list(adapt_delta = 0.95),
  # Sample priors to later compare priors vs posterior distributions
  sample_prior = TRUE,
  data = data
)

# Save the object to a specified folder path
my_path <- file.path(getwd(), "your_folder")
saveRDS(fit1, path = file.path(my_path, "mv_model1.rds"))

```

**Code for Model 2 where we control for prey behaviour :**

```{r eval = FALSE}

# Model 1
fit2 <- brm(
  # The three model formulas are summed
  speed_form2 +
  space_form2 +
  hook_form2 +
  # To estimate residual correlations
  # i.e. inference about behavioural plasticity
  set_rescor(TRUE),
  # MCMC settings to obtain 1000 posterior samples
  # (iter - warmups) / thin * chains
  warmup = 500,
  iter = 2500,
  thin = 8,
  chains = 4,
  # Initialize parameter values at 0
  inits = "0",
  # Within-chain parallelization :
  # Use only if you have access to multiple computer cores
  threads = threading(10),
  # Software backend for MCMC estimation
  backend = "cmdstanr",
  seed = 123,
  prior = priors,
  # Helps MCMC convergence
  control = list(adapt_delta = 0.95),
  # Sample priors to later compare priors vs posterior distributions
  sample_prior = TRUE,
  data = data
)

# Save the object to a specified folder path
my_path <- file.path(getwd(), "your_folder")
saveRDS(fit2, path = file.path(my_path, "mv_model2.rds"))

```


## Model verification

### Inspect chains

```{r eval = FALSE}

```

### Inspect model fit

```{r eval = FALSE}

```

### Inspect overlap between prior and posterior distributions

```{r eval = FALSE}

```

<br>



# Interpret the models' results

## Fixed effects - population-level parameters

## Random effects - group-level parameters